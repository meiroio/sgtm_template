___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Meiro",
  "categories": [
    "CONVERSIONS",
    "ANALYTICS",
    "DATA_PROCESSING",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Optimics \u0026 Meiro",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Official Meiro SGTM Template",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "meiroServerAddress",
    "displayName": "Endpoint URL address",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "notSetText": "Valid URL must be provided.",
    "help": "URL where every event will be sent.",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "(https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})"
        ],
        "errorMessage": "Valid URL must be provided."
      }
    ],
    "valueHint": "https://profile.meiro.com"
  },
  {
    "type": "SELECT",
    "name": "eventTypeSelection",
    "displayName": "Select event type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "page_view",
        "displayValue": "page_view"
      },
      {
        "value": "custom_event",
        "displayValue": "custom_event"
      },
      {
        "value": "web_banner_click",
        "displayValue": "web_banner_click"
      },
      {
        "value": "web_banner_impression",
        "displayValue": "web_banner_impression"
      },
      {
        "value": "contact_form_submit",
        "displayValue": "contact_form_submit"
      },
      {
        "value": "outbound_link_click",
        "displayValue": "outbound_link_click"
      }
    ],
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "List of all events: \u003ca href\u003d\"https://docs.meiro.io/books/meiro-events/page/events-list-of-events\"\u003ehttps://docs.meiro.io/books/meiro-events/page/events-list-of-events\u003c/a\u003e"
  },
  {
    "type": "GROUP",
    "name": "groupEventTypeDetails",
    "displayName": "Event Type Details",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customParameterOverrideTable",
        "displayName": "Custom Payload Parameters to Include",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "key",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add new custom payload parameter",
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "page_view",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "ga4MappingEventsPW",
        "checkboxText": "Map GA4 Event Parameters into Meiro Custom Payload",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "displayName": "Google Analytics 4 Mapping",
        "help": "",
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "page_view",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customExludeParameterTablePW",
        "displayName": "Event Parameters derived from GA4 to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "GA4 Event Parameter Name",
            "name": "key",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Exclude another parameter",
        "enablingConditions": [
          {
            "paramName": "ga4MappingEventsPW",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customEventParameterTable",
        "displayName": "Custom Event Parameters to Include",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "key",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add new custom event parameter",
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "custom_event",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "ga4MappingEventsCE",
        "checkboxText": "Map GA4 Event Parameters into Meiro Custom Event Parameters",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "displayName": "Google Analytics 4 Event Mapping",
        "help": "",
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "custom_event",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customExludeParameterTableCE",
        "displayName": "Event Parameters derived from GA4 to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "GA4 Event Parameter Name",
            "name": "key",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Exclude parameter",
        "enablingConditions": [
          {
            "paramName": "ga4MappingEventsCE",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "gaMappingEcommerce",
        "checkboxText": "Map GA4 Ecommerce Transaction And Item Object Into Meiro Custom Payload",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "defaultValue": true,
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "custom_event_disable",
            "type": "EQUALS"
          }
        ],
        "displayName": "Google Analytics 4 Ecommerce Mapping"
      },
      {
        "type": "CHECKBOX",
        "name": "ga4MappingOutboundLinks",
        "checkboxText": "Map GA4 Event OutboundLink into Meiro Outbound link",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "displayName": "Google Analytics 4 Event Mapping",
        "help": "",
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "outbound_link_click",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "customOutboundLink",
        "displayName": "Provide Outbounbd link URL",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ga4MappingOutboundLinks",
            "paramValue": false,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "customWebBannerID",
        "displayName": "Provide Web Banner ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "web_banner_click",
            "type": "EQUALS"
          },
          {
            "paramName": "eventTypeSelection",
            "paramValue": "web_banner_impression",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "customWebBannerDestinationID",
        "displayName": "Provide Destination ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "web_banner_click",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "groupFormSubmitData",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "GROUP",
            "name": "groupFormSubmitDefaultFields",
            "displayName": "Form Default Fields",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "TEXT",
                "name": "formSubmit_form_id",
                "displayName": "form_id",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_email",
                "displayName": "email",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_first_name",
                "displayName": "first_name",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_last_name",
                "displayName": "last_name",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_phone_number",
                "displayName": "phone_number",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_national_id",
                "displayName": "national_id",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_gender",
                "displayName": "gender",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_birthdate",
                "displayName": "birthdate",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_whatsapp",
                "displayName": "whatsapp",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_instagram",
                "displayName": "instagram",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_facebook",
                "displayName": "facebook",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_linkedin",
                "displayName": "linkedin",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_internal_user_id",
                "displayName": "internal_user_id",
                "simpleValueType": true
              },
              {
                "type": "TEXT",
                "name": "formSubmit_external_id",
                "displayName": "external_id",
                "simpleValueType": true
              }
            ]
          },
          {
            "type": "GROUP",
            "name": "groupFormSubmitCustomFields",
            "displayName": "Form Custom Fields",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "SIMPLE_TABLE",
                "name": "submitFormFieldTable",
                "displayName": "Custom Form Fields",
                "simpleTableColumns": [
                  {
                    "defaultValue": "",
                    "displayName": "Custom Field ID",
                    "name": "key",
                    "type": "TEXT"
                  },
                  {
                    "defaultValue": "",
                    "displayName": "Custom Field Value",
                    "name": "value",
                    "type": "TEXT"
                  }
                ],
                "newRowButtonText": "Add new field"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "eventTypeSelection",
            "paramValue": "contact_form_submit",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "ga4MappingRules",
    "displayName": "Client Identification",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "meiroUserIdSource",
        "displayName": "User ID source",
        "radioItems": [
          {
            "value": "browserCookie",
            "displayValue": "Meiro Browser Useir ID Cookie",
            "help": "meiro_user_id - UUID generated for each visitor with the longest possible expiration if not set differently on the ME instance. Fallback to meiro_user_id _js cookie."
          },
          {
            "value": "ga4ClientId",
            "displayValue": "Convert GA4 Client ID Into Meiro User ID",
            "help": "Convert GA4 client_id (timestamp.random) Identifier Into Meiro Compatible UUIDv4 String"
          },
          {
            "value": "hybrid",
            "displayValue": "Hybrid (Meiro Cookie first, GA4 as a fallback)"
          },
          {
            "value": "manualMapping",
            "displayValue": "Manual User ID mapping",
            "help": "Must follow this pattern: \u003cstrong\u003e\u002700000000-0000-0000-0000-0000000000\u0027\u003c/strong\u003e"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "browserCookie",
        "help": "\u003ca href\u003d\"https://docs.meiro.io/books/meiro-events/page/cookies-and-data-stored-in-browser-storages\"\u003eMeiro ID\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "customUserId",
        "displayName": "Provide valid Meiro User Id",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "meiroUserIdSource",
            "paramValue": "manualMapping",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "RADIO",
        "name": "meiroSessionIdSource",
        "displayName": "Session ID source",
        "radioItems": [
          {
            "value": "browserCookie",
            "displayValue": "Meiro Browser Session ID Cookie",
            "help": "meiro_session_id  with fallback to meiro_session_id _js"
          },
          {
            "value": "ga4SessionId",
            "displayValue": "Convert GA4 Session ID Into Meiro Session ID",
            "help": "Convert GA4 sid Identifier Into Meiro Compatible Session ID"
          },
          {
            "value": "hybrid",
            "displayValue": "Hybrid (Meiro Cookie first, GA4 as a fallback)"
          },
          {
            "value": "manualMapping",
            "displayValue": "Manual Session ID mapping",
            "help": ""
          }
        ],
        "simpleValueType": true,
        "defaultValue": "browserCookie",
        "help": "\u003ca href\u003d\"https://docs.meiro.io/books/meiro-events/page/cookies-and-data-stored-in-browser-storages\"\u003eMeiro ID\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "customSessionId",
        "displayName": "Provide valid Meiro Session ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "meiroSessionIdSource",
            "paramValue": "manualMapping",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "RADIO",
        "name": "meiroExternalIdSource",
        "displayName": "External ID source",
        "radioItems": [
          {
            "value": "ga4UserId",
            "displayValue": "Convert GA4 User ID Into Meiro External ID",
            "help": "Use GA4 User Id Identifier as Meiro External ID"
          },
          {
            "value": "manualMapping",
            "displayValue": "Manual External ID mapping",
            "help": "Provide string or associative array with external IDs"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "ga4UserId",
        "help": "\u003ca href\u003d\"https://docs.meiro.io/books/meiro-events/page/external-id-definecollect-external-id\"\u003eExternal ID\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "customExternalId",
        "displayName": "External ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "meiroExternalIdSource",
            "paramValue": "manualMapping",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customOverridesGroups",
    "displayName": "Custom Overrides",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "GROUP",
        "name": "groupPageDetail",
        "displayName": "Page details",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "TEXT",
            "name": "customPageTitle",
            "displayName": "Page Title",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customPageLocation",
            "displayName": "Page Location",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customReferrer",
            "displayName": "Referrer",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customIpOverride",
            "displayName": "IP Override",
            "simpleValueType": true
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "groupBrowserDetail",
        "displayName": "Browser detail",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "TEXT",
            "name": "customUserAgent",
            "displayName": "User-Agent String",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customBrowserHeight",
            "displayName": "Browser Window Height",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customBrowserWidth",
            "displayName": "Browser Window Width",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customBrowserColorDepth",
            "displayName": "Browser Color Depth",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "customBrowserCookies",
            "displayName": "Cookies Support",
            "simpleValueType": true
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentGroup",
    "displayName": "Consent Mode",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "ga4MappingConsents",
        "checkboxText": "Map GA4 Consent Mode Parameters",
        "simpleValueType": true,
        "help": "Convert GCS values G100, G110, G101, G111 Into Meiro Use Cookie Parameter",
        "defaultValue": true,
        "alwaysInSummary": true
      },
      {
        "type": "TEXT",
        "name": "customConsent",
        "displayName": "Custom consent status (bool)",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ga4MappingConsents",
            "paramValue": false,
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

/*
        Meiro Server-Side GTM Template  

    Written by Jakub Kriz @ Optimics s.r.o.
           jakub.kriz@optimics.cz
*/

// SGTM Sandboxed APIs
const Math = require('Math');
const JSON = require('JSON');
const Object = require('Object');
const sha256 = require('sha256Sync');
const toBase64 = require('toBase64');
const testRegex = require('testRegex');
const setCookie = require('setCookie');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const createRegex = require('createRegex');
const logToConsole = require('logToConsole');
const getEventData = require('getEventData');
const getCookieValues = require('getCookieValues');
const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const getTimestampMillis = require('getTimestampMillis');

// Version
const templateVersion = '2024-04-05';

// Logging wrapper
function log(message, noPrefix){
  const prefix = 'Meiro: ';
  logToConsole(noPrefix === true ? message : prefix + message);
}

logToConsole('Version - ' + templateVersion);

// Convert most array of object with key and value parameters names into key value object
function convertArrayToObject(arr) {
  const obj = {};  
  arr.forEach(item => {
    obj[item.key] = item.value;
  });  
  return obj;
}

// Merge two objects into one
function mergeObjects(obj1, obj2){
  var obj3 = {};
  for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
  for (var attrname2 in obj2) { obj3[attrname2] = obj2[attrname2]; }
  return obj3;
}

// Undefined value prevents sending empty keys in payload
function removeUndefinedProps(obj) {
  for (var prop in obj) {
    if (obj.hasOwnProperty(prop) && obj[prop] === undefined) {
      log('Deleting: ' + prop);
      Object.delete(obj, prop);
    }
  }
  return obj;
}

// Extract nested stucture by defined key into simple array of values
function flattenSimpleObject(inputArray, keyName) {
      keyName = keyName || 'key';
  var flattenedArray = [];
  // Loop through the objects in the input array
  for (var i = 0; i < inputArray.length; i++) {
    var obj = inputArray[i];
    // Check if the object has a "key" property
    if (obj.hasOwnProperty(keyName)) {
      flattenedArray.push(obj.key);
    } else {
     log('Object does not have key called: ' + keyName);
    }
  }
  return flattenedArray;
}

// Remove all keys defined in exludeKeys object from inputObject
function removeSelectedProps(inputObject, excludeKeys) {
   // Create a new object to store the filtered key-value pairs
  var filteredObject = {};
  // Loop through the keys in the input object
  for (var key in inputObject) {
    if (inputObject.hasOwnProperty(key) && excludeKeys.indexOf(key) === -1) {
      // Add the key-value pair to the filtered object if it's not in the exclude list
      filteredObject[key] = inputObject[key];
    }
  }
  return filteredObject;
}

// Filter-in only keys with given prefix
function filterObjectByPrefix(obj, prefix, filterOut) {
  var filteredObject = {};  
  for (var key in obj) {
    if (obj.hasOwnProperty(key) && key.indexOf(prefix) === 0) {
      if(filterOut){
        filteredObject[key.substring(prefix.length)] = obj[key];
      } else {
        filteredObject[key] = obj[key];
      }      
    }
  }
  return filteredObject;
}

// From given string generate UUIDv5 like string
function generateUUIDv5(seed){
  let uuid = sha256(seed, {outputEncoding: 'hex'});  
  uuid = makeString(uuid);  
  const uuidRegex = createRegex('(\\w{8})(\\w{4})(\\w{4})(\\w{4})(\\w{12}).*', 'i');
  return uuid.replace(uuidRegex, '$1-$2-$3-$4-$5');
}

// Convert given timestamp in unix millis format to ISO 8601 format
function convertTimestamp(timestamp) {
  var millisecondsPerDay = 24 * 60 * 60 * 1000;
  var millisecondsPerHour = 60 * 60 * 1000;  
  var millisecondsPerMinute = 60 * 1000;
  var millisecondsPerSecond = 1000;  

  timestamp = timestamp - 1 * millisecondsPerDay;
    
  var totalDays = Math.floor(timestamp / millisecondsPerDay);
  var remainingTime1 = timestamp % millisecondsPerDay;
  
  var hours = Math.floor(remainingTime1 / millisecondsPerHour);
  var remainingTime2 = remainingTime1 % millisecondsPerHour;
  
  var minutes = Math.floor(remainingTime2 / millisecondsPerMinute);
  var remainingTime3 = remainingTime2 % millisecondsPerMinute;
  
  var seconds = Math.floor(remainingTime3 / millisecondsPerSecond);
  var milliseconds = remainingTime3 % millisecondsPerSecond;  
  
  var year = 1970; // Unix epoch year
  var daysPerYear = 365.25; // Average days per year considering leap years
  var leapYearAdjustment = 2; // Adjust for leap year
  var daysSinceEpoch = totalDays + leapYearAdjustment;
  
  var remainingDays = daysSinceEpoch;
  var currentYear = year;
  var isLeapYear = false;
  
  while (remainingDays > daysPerYear) {
    isLeapYear = (currentYear % 4 === 0 && currentYear % 100 !== 0) || (currentYear % 400 === 0);
    var daysInYear = isLeapYear ? 366 : 365;    
    if (remainingDays > daysInYear) {      
      remainingDays = remainingDays - daysInYear;
      currentYear++;
    }
  }
  
  var monthDays = [31, isLeapYear ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  var month = 0;  
  for (var i = 0; i < monthDays.length; i++) {
    if (remainingDays <= monthDays[i]) {
      month = i + 1;
      break;
    }
    remainingDays = remainingDays - monthDays[i];
  }  
  var day = remainingDays;  
  return currentYear + "-" + padZero(month) + "-" + padZero(day) + "T" + padZero(hours) + ":" + padZero(minutes) + ":" + padZero(seconds) + "." + padZero(milliseconds, 3) + "Z";
}

// Prefix short numbers with leading 0
function padZero(value, length) {
  var newLength = length || 2;
  var newValue = value.toString();
  while (newValue.length < newLength) {
    newValue = "0" + newValue;
  }
  return newValue;
}

// Meiro event versions
function getEventVersion(event){
  const versions = {
    'page_view': '1.2.0',
    'custom_event': '1.3.0',
    'web_banner_click': '1.0.0',
    'web_banner_impression': '1.0.0',
    'contact_form_submit': '1.1.0',
    'outbound_link_click': '1.3.0'
  };
  return versions[event] || '1.0.0';
}

// Payload is versatile for each hit. custom_event has flexible payload scheme
function getPayload(){
  const payloadDefaults = {
    page_title: getPageTitle(),
    url: getPageLocation(),
    referrer: getReferrer()
  };
  
  // Event specific payload
  const eventType = getEventType();
  let payloadCustom = {};
  
  switch (eventType) {
    case 'page_view':
      payloadCustom.custom_payload = getCustomPayload();
      break;
    case 'custom_event':      
      payloadCustom = mergeObjects(payloadCustom, getEventPayload());
      break;
    case 'web_banner_click':
      payloadCustom.banner_id = getBannerImpressionID();
      payloadCustom.destination_url = getBannerDestinatinClickURL();
      break;
    case 'web_banner_impression':
      payloadCustom.banner_id = getBannerImpressionID();
      break;
    case 'contact_form_submit':
      payloadCustom = mergeObjects(payloadCustom, getFormSubmitPayload());
      break;
    case 'fb_cid_sync':
      payloadCustom.client_id = getFacebookSyncID();
      break;
    case 'ga_cid_sync':
      payloadCustom.client_id = getGoogleAnalyticsCID();
      break;
    case 'outbound_link_click':
      payloadCustom.href = getOutboundLink();
      break;
    default:
    log('Unknown event type ' + eventType);
  }
  return mergeObjects(payloadDefaults, payloadCustom);
}

/* Get payload related variable values */
function getEventType(){
  return data.eventTypeSelection;
}

/* Get all SGTM Event Data Object */
function getEventDataAll(){
  return getAllEventData() || {};
}

// Custom payload is specific only for page_view event
function getCustomPayload(){
  // Return object with custom configs  
  const customParams = convertArrayToObject(data.customParameterOverrideTable || []) || {};
  // Return ga4 event variables from GA4 Client
  // const eventData = data.ga4MappingEventsPW ? filterObjectByPrefix(getRequestQueryParameters(), 'ep.', true) : {};
  
  // Return event data object
  const eventData = data.ga4MappingEventsPW ? getEventDataAll() : {};
  
  // Get list of filtered parameters
  const eventDataExcludeList = flattenSimpleObject(data.customExludeParameterTablePW || [], 'key');

  // Return filtered event variables from exclude filter
  const filteredEventParams = removeSelectedProps(eventData, eventDataExcludeList);

  return (data.ga4MappingEventsPW === true ? mergeObjects(filteredEventParams, customParams) : customParams);
}

// Prepare complete form submit event payload structure
function getFormSubmitPayload(){
  const formStandardFields = {
    form_id: data.formSubmit_form_id, // requiredemail: data.formSubmit_email, // john@doe.com (optional, string)
    first_name: data.formSubmit_first_name, // John (optional, string)
    last_name: data.formSubmit_last_name, // Doe (optional, string)
    phone_number: data.formSubmit_phone_number, // +420439847320 (optional, string)
    national_id: data.formSubmit_national_id, // CZE (optional, string)
    gender: data.formSubmit_gender, // male (optional, string)
    birthdate: data.formSubmit_birthdate, // 10-10-1992 (optional, string)
    whatsapp: data.formSubmit_whatsapp, // @hodlmao (optional, string)
    instagram: data.formSubmit_instagram, // maleshe (optional, string)
    facebook: data.formSubmit_facebook, // JohnDoe10023 (optional, string)
    linkedin: data.formSubmit_linkedin, // JohnDoeB (optional, string)
    internal_user_id: data.formSubmit_internal_user_id, // 439FID43 (optional, string)
    external_id: data.formSubmit_external_id, // 43FSOSOIRTEOI43 (optional, string)
  };
  // Convert array into objects - keys:  
  const formCustomFieldsSource = convertArrayToObject(data.submitFormFieldTable || []);
  
  let formCustomFields = {};  
  for (var field_id in formCustomFieldsSource) {
    if (formCustomFieldsSource.hasOwnProperty(field_id) && field_id >= 0 && field_id <= 30) {
      formCustomFields["field" + padZero(field_id)] = formCustomFieldsSource[field_id];
    }  
  }
  // Generate 0 - 30 fields from user input here
  return mergeObjects(formStandardFields, formCustomFields);
}

// Prepare custom payload for pageview event
function getEventPayload(){
  // Return object with custom configs  
  const customParams = convertArrayToObject(data.customEventParameterTable || []) || {};
  // Return ga4 event variables from GA4 Client
  // const eventData = data.ga4MappingEventsCE ? filterObjectByPrefix(getRequestQueryParameters(), 'ep.', true) : {};
    
  // Return event data object
  const eventData = data.ga4MappingEventsCE ? getEventDataAll() : {};

  // Get list of filtered parameters
  const eventDataExcludeList = flattenSimpleObject(data.customExludeParameterTableCE || [], 'key');

  // Return filtered event variables from exclude filter
  const filteredEventParams = removeSelectedProps(mergeObjects({'event_name': getEventData('event_name')}, eventData), eventDataExcludeList);

  return (data.ga4MappingEventsCE === true ? mergeObjects(filteredEventParams, customParams) : customParams);
}

// Prepare output payload for outbound link event
function getOutboundLink(){
  const outboundLinkGA4 = (getEventData('outbound') === 'true' ? getEventData('link_url') : undefined);
  const outboundLinkManual = data.customOutboundLink;
  return (data.ga4MappingOutboundLinks === true ? outboundLinkGA4 : outboundLinkManual);
}

// Prepare Facebook sync id
function getFacebookSyncID(){  
  const fbRegexFull = createRegex('^\\w+\\.\\d+\\.\\d+\\.\\d+$', 'i');
  const fbRegexReduced = createRegex('^\\d+\\.\\d+$', 'i');
  const fbIdInput  = data.customFB_cid_sync;
  let outputFbId = "";  

  if (fbRegexFull === null && fbRegexReduced === null) {
    outputFbId =  "";
  } else if(testRegex(fbRegexFull, fbIdInput)){
    outputFbId = fbIdInput.split('.')[2] + '.' + fbIdInput.split('.')[3];
  }  else if(testRegex(fbRegexReduced, fbIdInput)){
    outputFbId = fbIdInput;
  } else {
    log('Unknown FB ID format used!');
    outputFbId = fbIdInput;
  }
  
  log('FB - Identifier value: ' + fbIdInput);
  log('FB - Full format match: ' + testRegex(fbRegexFull, fbIdInput));
  log('FB - Reduced format match: ' + testRegex(fbRegexReduced, fbIdInput));
  log('FB used ID: ' + outputFbId);
  return outputFbId;
}

function getBannerImpressionID(){
  return data.customWebBannerID;
}

function getBannerDestinatinClickURL(){
  return data.customWebBannerDestinationID;
}

function getGoogleAnalyticsCID(){
  log("GACID MANUAL: " + data.customGA4_cid_sync);
  return data.customGA4_cid_sync || (data.ga4MappingGA4_cid_sync === true ? getEventData('client_id') : undefined);
}

/* Get standalone variable values */
function getReferrer(){
  return data.customReferrer || getEventData('page_referrer') || '';
}

function getPageLocation(){
  return data.customPageLocation || getEventData('page_location') || '';
}

function getPageTitle(){
  return data.customPageTitle || getEventData('page_title') || '';
}

function getUserIdNull(){
  return '00000000-0000-0000-0000-0000000000';
}

function getUserIdFromGa4ClientId(){
  return generateUUIDv5(getEventData('client_id')) || undefined;
}

function getMeiroUserIdFromCookie(){
  const meiroCookie = getCookieValues('meiro_user_id')[0];
  const meiroCookieBackup = getCookieValues('meiro_user_id_js')[0];
  return meiroCookie ? meiroCookie : meiroCookieBackup ? meiroCookieBackup : undefined;
}

function getUserId(){  

  switch (data.meiroUserIdSource) {
    case 'browserCookie':
      return getMeiroUserIdFromCookie() || getUserIdNull();
    case 'ga4ClientId':
      return getUserIdFromGa4ClientId() || getUserIdNull();
    case 'hybrid':
      let meiroUserId = getMeiroUserIdFromCookie();
      let gaUserId = getUserIdFromGa4ClientId();
      return meiroUserId ? meiroUserId : gaUserId ? gaUserId : getUserIdNull();
    case 'manualMapping':
      return data.customUserId || getUserIdNull();
    default:
      return getUserIdNull();
  }
}

function getMeiroSessionIdFromCookie(){
  const meiroCookie = getCookieValues('meiro_session_id')[0];
  const meiroCookieBackup = getCookieValues('meiro_session_id_js')[0];
  return meiroCookie ? meiroCookie : meiroCookieBackup ? meiroCookieBackup : undefined;
}

function getSessionIdFromGa4SessionId(){
  return (toBase64(getEventData('ga_session_id') + getUserId())) || undefined;
}

function getSessionIdNull(){
  return toBase64('000000000000000000000000000000');
}

function getSessionId(){

  switch (data.meiroSessionIdSource) {
    case 'browserCookie':
      return getMeiroSessionIdFromCookie() || getSessionIdNull();
    case 'ga4SessionId':
      return getSessionIdFromGa4SessionId() || getSessionIdNull();
    case 'hybrid':
      let meiroSessionId = getSessionIdFromGa4SessionId();
      let gaSessionId = getMeiroSessionIdFromCookie();
      return meiroSessionId ? meiroSessionId : gaSessionId ? gaSessionId : getSessionIdNull();
    case 'manualMapping':
      return data.customSessionId || getSessionIdNull();
    default:
      return getSessionIdNull();
  }
}

function getExternalId(){
  switch (data.meiroExternalIdSource) {
    case 'ga4UserId':
      return getEventData('user_id') || undefined;
    case 'manualMapping':
      return data.customExternalId || undefined;
    default:
      return undefined;
  }
}

function getClientIds(){
  return {
    fb: getGoogleAnalyticsCID() ||  null,
    ga: getFacebookSyncID() || null
  };
}

// this function get original clients IP address, Meiro does not support this override now
function getIpOverride(){
  return data.customIpOverride || getEventData('ip_override');
}

function getUserAgent(){
  return data.customUserAgent || getEventData('user_agent');  
}

function getCookieConsentState(){
  /*
    ## Cookies enabled decision logic ##    
    - undefined => unable to detect cookies => false
    - G100 => cookies disabled by tracker => false
    - G110 => cookies enabled for ads => true
    - G101 => cookies enabled for analytics => true
    - G111 => cookies enabled for both, ads and analytics => true
  */
  const ga4Consents = getEventData('x-ga-gcs') || 'G100';
  const cookiesRegex = createRegex('G100', 'i');  
  const cookies = ga4Consents.match(cookiesRegex) !== null ? false : true;
  return (data.ga4MappingConsents === true ? cookies : data.customConsent) || false;
}

// Return browser metric object
function getBrowserMetrics(){
  const ga4Screen = getEventData('screen_resolution') || '640x480'; // set default ancient resolution to prevent non-zero values
  const heightRegex = createRegex('.*x(\\d+)','i');
  const height = ga4Screen.replace(heightRegex, '$1');
  const widthRegex = createRegex('(\\d+)x.*','i');
  const width = ga4Screen.replace(widthRegex, '$1');  
  const color = 32; // it is not possible to obtain this value from GA4 Event Data, constant 32 is used instead  
  return {
    inner_height: makeInteger(data.customBrowserHeight || height),
    inner_width: makeInteger(data.customBrowserWidth || width),
    color_depth: makeInteger(data.customBrowserColorDepth || color),
    cookies_enabled: getCookieConsentState()
  };
}

// Parse server response and try to store cookie via client backpropagation mechanism
function processMeiroResponse(result){
  const decodedResult = result;
  const resultHeader = decodedResult.headers;
  
  if(resultHeader && resultHeader['set-cookie']){
    const resultCookies = resultHeader['set-cookie'][0] || [];
    const cookieValue = resultCookies.split("meiro_user_id=").pop().split(';').shift();
    const cookieExpires = resultCookies.split("expires=").pop().split(';').shift();
    log(cookieValue);
    
    setCookie('meiro_user_id', cookieValue, {
      domain: 'auto',
      expires: cookieExpires,
      path: '/',
      samesite: 'Lax',
      secure: true,
      'max-age': cookieExpires,
      httpOnly: true
    }, false);    
  }
}

// Send prepared data to Meiro collection API
function processMeiroRequest(){
  const eventType = getEventType();
  // Complete output object
  var payloadObject = {
    type: eventType,
    timestamp: convertTimestamp(getTimestampMillis()),
    version: getEventVersion(eventType),
    payload: getPayload(),
    user_id: getUserId(),  
    session_id: getSessionId(),  
    external_id: getExternalId(),
    browser_metrics: getBrowserMetrics(),
    client_ids: getClientIds()
  };

  // Log template state details
  log('Template config data');
  log(data, true);

  log('GTM Client Event Data');
  log(getEventDataAll(), true);

  log('Custom Overrides From Config');
  log(getCustomPayload(), true);

  log('Browser Metrics Object');
  log(getBrowserMetrics(), true);

  log('Payload Object');
  log(payloadObject, true);

  // Send request to Meiro servers
  let payloadArr = [];
  payloadArr.push(payloadObject);
  // The payload object is converted to a JSON string.
  const payloadJSON = JSON.stringify(payloadArr);
  const currentConsentState = getCookieConsentState().toString();
  const urlAddress = data.meiroServerAddress;
  const requestHeaders = {
    'X-Meiro-Inbound-User-Ids-Consent': currentConsentState,
    'X-Meiro-User-Id-Consent': currentConsentState,
    'X-Meiro-Ip-Address-Override': getIpOverride(),
    'Content-Type': 'application/json; charset=utf-8',
    'User-Agent': getUserAgent()
  };

  if(urlAddress) {
    log('Sending data to server...');
    log(urlAddress);
    log(JSON.stringify(requestHeaders), true);
    log(payloadJSON, true);
    
    sendHttpRequest(urlAddress, {
      headers: requestHeaders,
      method: 'POST',
      timeout: 5000,
    }, payloadJSON).then((result) => {
      log('Server response:'); 
      processMeiroResponse(result);
      log(JSON.stringify(result), true);
    });

    data.gtmOnSuccess();
  } else {
    log('URL address not provided');
    data.gtmOnFailure();
  }
}
processMeiroRequest();
// This is the end


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "meiro_user_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "non_session"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "meiro_user_id"
              },
              {
                "type": 1,
                "string": "meiro_user_id_js"
              },
              {
                "type": 1,
                "string": "meiro_session_id"
              },
              {
                "type": 1,
                "string": "meiro_session_id_js"
              },
              {
                "type": 1,
                "string": "meiro_synced_fb_cid"
              },
              {
                "type": 1,
                "string": "meiro_synced_ga_cid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Init
  code: |-
    const mockData = {
        "ga4MappingSessionId":true,
        "ga4MappingCustomParametersEnabled":true,
        "ga4MappingUserId":true,
        "gaMappingEcommerce":true,
        "gaMappingConsents":true,
        "meiroServerAddress":"https://staging.me.meiro.dev/",
        "ga4MappingClientId":true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event pageview
  code: |-
    const mockData = {
      "customParameterOverrideTable": [
        {
          "key":"custom_param_1",
          "value":"my_value_1"
        },
        {
          "key":"custom_param_2",
          "value":"my_value_2"
        }
    ],
      "ga4MappingSessionId":true,
      "ga4MappingEventsPW":true,
      "ga4MappingUserId":true,
      "meiroServerAddress":"https://staging.me.meiro.dev/",
      "eventTypeSelection":"page_view",
      "ga4MappingClientId":true,
      "ga4MappingConsents":true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event custom_event - with custom event parameters
  code: |-
    const mockData = {
        "ga4MappingSessionId": true,
        "customEventParameterTable": [{
            "key": "mycustom001",
            "value": "customvalue001"
        }, {
            "key": "mycustom002",
            "value": "customvalue002"
        }],
        "ga4MappingUserId": true,
        "gaMappingEcommerce": false,
        "ga4MappingEventsCE": false,
        "ga4MappingClientId": true,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "custom_event",
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event web_banner_click
  code: |-
    const mockData = {
        "ga4MappingSessionId": true,
        "customWebBannerDestinationID": "dest id",
        "ga4MappingUserId": true,
        "customWebBannerID": "ban id",
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "web_banner_click",
        "ga4MappingClientId": true,
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event web_banner_impression
  code: |-
    const mockData = {
        "ga4MappingSessionId": true,
        "ga4MappingUserId": true,
        "customWebBannerID": "banner impression id",
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "web_banner_impression",
        "ga4MappingClientId": true,
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event contact_form_submit
  code: |-
    const mockData ={
        "formSubmit_linkedin": "linkedin",
        "formSubmit_email": "email",
        "formSubmit_facebook": "facebook",
        "formSubmit_whatsapp": "whatsapp",
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "contact_form_submit",
        "formSubmit_instagram": "instagram",
        "ga4MappingConsents": true,
        "submitFormFieldTable": [{
            "key": "0",
            "value": "myvalue00"
        }, {
            "key": "1",
            "value": "myvalue01"
        }, {
            "key": "30",
            "value": "myvalue30"
        }, {
            "key": "54",
            "value": "myvalue54"
        }],
        "ga4MappingSessionId": true,
        "formSubmit_national_id": "national_id",
        "formSubmit_phone_number": "phone_number",
        "formSubmit_form_id": "form_id",
        "formSubmit_last_name": "last_name",
        "ga4MappingUserId": true,
        "formSubmit_first_name": "first_name",
        "formSubmit_gender": "gender",
        "ga4MappingClientId": true,
        "formSubmit_birthdate": "birthdate",
        "formSubmit_internal_user_id": "internal_user_id",
        "formSubmit_external_id": "external_id"
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event optimizely_data_sync
  code: |-
    const mockData = {
        "optimizely_variations": "variations",
        "optimizely_revision": "revision",
        "optimizely_audiences": "audiences",
        "optimizely_visitorId": "visitorId",
        "optimizely_accountId": "accountId",
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "optimizely_data_sync",
        "ga4MappingConsents": true,
        "optimizely_projectId": "projectId",
        "ga4MappingSessionId": true,
        "optimizely_campaigns": "campaigns",
        "ga4MappingUserId": true,
        "optimizely_experiments": "experiments",
        "ga4MappingClientId": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event fb_cid_sync - full format
  code: |-
    const mockData ={
        "ga4MappingSessionId": true,
        "ga4MappingUserId": true,
        "ga4MappingClientId": true,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "fb_cid_sync",
        "customFB_cid_sync": "fb.1.15485451.21856425",
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event fb_cid_sync - reduced format
  code: |-
    const mockData ={
        "ga4MappingSessionId": true,
        "ga4MappingUserId": true,
        "ga4MappingClientId": true,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "fb_cid_sync",
        "customFB_cid_sync": "15485451.21856425",
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event ga_cid_sync - manual
  code: |-
    const mockData = {
        "customGA4_cid_sync": "manual gacid value",
        "ga4MappingSessionId": true,
        "ga4MappingUserId": true,
        "ga4MappingGA4_cid_sync": false,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "ga_cid_sync",
        "ga4MappingClientId": true,
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event ga_cid_sync - automatic
  code: |-
    const mockData = {
        "ga4MappingSessionId": true,
        "ga4MappingUserId": true,
        "ga4MappingGA4_cid_sync": true,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "ga_cid_sync",
        "ga4MappingClientId": true,
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Event outbound_link_click
  code: |-
    const mockData = {
        "customOutboundLink": "https://kamsi.com",
        "ga4MappingSessionId": true,
        "ga4MappingOutboundLinks": false,
        "ga4MappingUserId": true,
        "meiroServerAddress": "https://staging.me.meiro.dev/",
        "eventTypeSelection": "outbound_link_click",
        "ga4MappingClientId": true,
        "ga4MappingConsents": true
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockEventData = {
    client_hints: {
      architecture: "x86",
      bitness: "64",
      full_version_list: [
        {brand: "Not.A/Brand", version: "8.0.0.0"},
        {brand: "Chromium", version: "114.0.5735.134"},
        {brand: "Google Chrome", version: "114.0.5735.134"}
      ],
      mobile: false,
      model: "",
      platform: "Windows",
      platform_version: "14.0.0",
      wow64: false,
      brands: [
        {brand: "Not.A/Brand", version: "8"},
        {brand: "Chromium", version: "114"},
        {brand: "Google Chrome", version: "114"}
      ]
    },
    client_id: "461306400.1679512015",
    event_name: "page_view",
    ga_session_id: "1686917533",
    ga_session_number: 6,
    ip_override: "2a02:8308:111:d800:e98b:c881:cd0c:f6d7",
    language: "cs-cz",
    page_location: "https://www.optimics.cz/",
    page_title: "Homepage - Optimics",
    page_referrer: "https://www.optimics.cz/",
    screen_resolution: "1707x960",
    user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",
    web_language: "cs-CZ",
    'x-ga-gcs': "G111",
    'x-ga-gtm_version': "45he36e0",
    'x-ga-measurement_id': "G-6R52NLCTYD",
    'x-ga-mp2-seg': "0",
    'x-ga-page_id': 1054000205,
    'x-ga-protocol_version': "2",
    'x-ga-request_count': 1,
    'x-ga-system_properties': {gaz: "1", ss: "1"},
    'x-sst-system_properties': {uc: "", rnd: "645168173.1686917533", gse: "1", gcd: "G100", adr: "1"}
  };

  mock('getEventData', function(a){
    return mockEventData[a] || undefined;
  });

  mock('getAllEventData', function(){
    return mockEventData;
  });


___NOTES___

This template is still in pilot testing phase.

Every implementation should be extensively tested.


